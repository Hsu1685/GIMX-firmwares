/*
 Copyright (c) 2019 Mathieu Laurendeau <mat.lau@laposte.net>
 License: GPLv3
 */

#include "../adapter_common.c"

#define REPORT_TYPE_OUTPUT  0x02
#define REPORT_TYPE_FEATURE 0x03

/*
 * The master bdaddr.
 */
static uint8_t masterBdaddr[6];

/*
 * A byte to save.
 */
static uint8_t byte_6_ef;

/*
 * Indicates if the master bdaddr was already requested or not.
 */
static uint8_t reply = 0;

const uint8_t PROGMEM report_01[] = {
    //Sixaxis
    /*0x00, 0x01, 0x03, 0x00, 0x04, 0x0c, 0x01, 0x02,
    0x18, 0x18, 0x18, 0x18, 0x09, 0x0a, 0x10, 0x11,
    0x12, 0x13, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00,
    0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x04,
    0x04, 0x04, 0x04, 0x00, 0x00, 0x01, 0x06, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,*/

    //Dualshock 3
    0x00, 0x01, 0x04, 0x00, 0x07, 0x0c, 0x01, 0x02,
    0x18, 0x18, 0x18, 0x18, 0x09, 0x0a, 0x10, 0x11,
    0x12, 0x13, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00,
    0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x04,
    0x04, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x01,
    0x02, 0x07, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t PROGMEM report_f2[] = {
    //Sixaxis
    /*0xf2, 0xff, 0xff, 0x00,
    0x01, 0x02, 0x03, 0x04, 0x05, 0x06, //device bdaddr
                0x00, 0x03, 0x50, 0x81, 0xd8, 0x01,
    0x8a, 0x00, 0x00, 0x01, 0x64, 0x19, 0x01, 0x00,
    0x64, 0x00, 0x01, 0x90, 0x00, 0x19, 0xfe, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,*/

    //Dualshock 3
    0xf2, 0xff, 0xff, 0x00,
    0x01, 0x02, 0x03, 0x04, 0x05, 0x06, //device bdaddr
                0x00, 0x03, 0x50, 0x81, 0xd8, 0x01,
    0x8a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00,
    0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x04,
    0x04, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x01,
    0x02, 0x07, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t PROGMEM report_f5[] = {
    //Sixaxis
    /*0x01, 0x00,
    0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, //dummy PS3 bdaddr
    0x23, 0x1e, 0x00, 0x03, 0x50, 0x81, 0xd8, 0x01,
    0x8a, 0x00, 0x00, 0x01, 0x64, 0x19, 0x01, 0x00,
    0x64, 0x00, 0x01, 0x90, 0x00, 0x19, 0xfe, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,*/

    //Dualshock 3
    0x01, 0x00,
    0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, //dummy PS3 bdaddr
    0xff, 0xf7, 0x00, 0x03, 0x50, 0x81, 0xd8, 0x01,
    0x8a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00,
    0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x04,
    0x04, 0x04, 0x04, 0x00, 0x00, 0x04, 0x00, 0x01,
    0x02, 0x07, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t PROGMEM report_ef[] = {
    //Sixaxis
    /*0x00, 0xef, 0x03, 0x00, 0x04, 0x03, 0x01, 0xb0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x02, 0x05, 0x01, 0x92, 0x02, 0x02, 0x01,
    0x91, 0x02, 0x05, 0x01, 0x91, 0x02, 0x04, 0x00,
    0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,*/

    //Dualshock 3
    0x00, 0xef, 0x04, 0x00, 0x07, 0x03, 0x01, 0xb0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x02, 0x6b, 0x02, 0x68, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t PROGMEM report_f8[] = {
    //Sixaxis
    /*0x00, 0x01, 0x00, 0x00, 0x07, 0x03, 0x01, 0xb0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x02, 0x6b, 0x02, 0x68, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,*/

    //Dualshock 3
    0x00, 0x01, 0x00, 0x00, 0x07, 0x03, 0x01, 0xb0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x02, 0x6b, 0x02, 0x68, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

const uint8_t PROGMEM report_f7[] = {
    //Sixaxis
    /*0x01, 0x00, 0x08, 0x03, 0xd2, 0x01, 0xee, 0xff,
    0x10, 0x02, 0x00, 0x03, 0x50, 0x81, 0xd8, 0x01,
    0x8a, 0x00, 0x00, 0x01, 0x64, 0x19, 0x01, 0x00,
    0x64, 0x00, 0x01, 0x90, 0x00, 0x19, 0xfe, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,*/

    //Dualshock 3
    0x01, 0x04, 0xc4, 0x02, 0xd6, 0x01, 0xee, 0xff,
    0x14, 0x13, 0x01, 0x02, 0xc4, 0x01, 0xd6, 0x00,
    0x00, 0x02, 0x02, 0x02, 0x00, 0x03, 0x00, 0x00,
    0x02, 0x00, 0x00, 0x02, 0x62, 0x01, 0x02, 0x01,
    0x5e, 0x00, 0x32, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

void EVENT_USB_Device_ControlRequest(void) {

    static uint8_t buffer[MAX_CONTROL_TRANSFER_SIZE];

    switch (USB_ControlRequest.bRequest) {
    case REQ_GetReport:
        if (USB_ControlRequest.bmRequestType == (REQDIR_DEVICETOHOST | REQTYPE_CLASS | REQREC_INTERFACE)) {
            uint8_t reportType = USB_ControlRequest.wValue >> 8;
            uint8_t reportId = USB_ControlRequest.wValue & 0xff;

            if (reportType == REPORT_TYPE_FEATURE) {
                const void *feature = NULL;
                uint8_t len = 0;

                switch (reportId) {
                case 0x01:
                    feature = report_01;
                    len = sizeof(report_01);
                    break;
                case 0xf2:
                    feature = report_f2;
                    len = sizeof(report_f2);
                    break;
                case 0xf5:
                    memcpy_P(buffer, report_f5, sizeof(buffer));
                    if (reply == 0) {
                        /*
                         * First request, tell that the bdaddr is not the one of the PS3.
                         */
                        reply = 1;
                    } else {
                        /*
                         * Next requests, tell that the bdaddr is the one of the PS3.
                         */
                        memcpy(buffer + 2, masterBdaddr, 6);
                    }
                    len = sizeof(report_f5);
                    break;
                case 0xef:
                    memcpy_P(buffer, report_ef, sizeof(buffer));
                    buffer[7] = byte_6_ef;
                    len = sizeof(report_ef);
                    break;
                case 0xf8:
                    memcpy_P(buffer, report_f8, sizeof(buffer));
                    buffer[7] = byte_6_ef; //necessary??
                    len = sizeof(report_f8);
                    break;
                case 0xf7:
                    feature = report_f7;
                    len = sizeof(report_f7);
                    break;
                default:
                    Serial_SendByte(BYTE_DEBUG);
                    Serial_SendByte(BYTE_LEN_1_BYTE);
                    Serial_SendByte(reportId);
                    break;
                }

                if (feature) {
                    Endpoint_ClearSETUP();
                    Endpoint_Write_Control_PStream_LE(feature, USB_ControlRequest.wLength);
                    Endpoint_ClearOUT();
                } else if (len) {
                    Endpoint_ClearSETUP();
                    Endpoint_Write_Control_Stream_LE(buffer, USB_ControlRequest.wLength);
                    Endpoint_ClearOUT();
                }
            }
        }
        break;
    case REQ_SetReport:
        if (USB_ControlRequest.bmRequestType == (REQDIR_HOSTTODEVICE | REQTYPE_CLASS | REQREC_INTERFACE)) {
            Endpoint_ClearSETUP();
            enum Endpoint_ControlStream_RW_ErrorCodes_t error = Endpoint_Read_Control_Stream_LE(buffer, USB_ControlRequest.wLength);
            Endpoint_ClearIN();

            if (error != ENDPOINT_RWCSTREAM_NoError) {
                break;
            }

            uint8_t reportType = USB_ControlRequest.wValue >> 8;
            uint8_t reportId = USB_ControlRequest.wValue & 0xff;

            if (reportType == REPORT_TYPE_FEATURE) {
                switch (reportId) {
                case 0xf5:
                    memcpy(masterBdaddr, buffer + 2, 6);
                    break;
                case 0xef:
                    byte_6_ef = buffer[6];
                    break;
                }
            } else if (reportType == REPORT_TYPE_OUTPUT) {
                switch (reportId) {
                case 0x01:
                    Serial_SendByte(BYTE_OUT_REPORT);
                    Serial_SendByte(USB_ControlRequest.wLength + 1);
                    Serial_SendByte(0x01);
                    Serial_SendData(buffer, USB_ControlRequest.wLength);
                    break;
                }
            }
        }
        break;

    }
}
